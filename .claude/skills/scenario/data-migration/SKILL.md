---
name: scenario-data-migration
description: 当需要规划并执行数据迁移，确保准确性、性能与可回滚能力时，请加载本技能。
allowed-tools: Read(*), Write(*), Edit(*), MultiEdit(*), Bash(*), Glob(*), Grep(*), TodoWrite
---

# 数据迁移技能

## 适用场景

- 系统重构、分库分表、跨环境迁移需要数据搬迁。
- 第三方系统导入/导出、历史数据清洗。
- 上线过程中需要灰度或增量同步。

## 前置准备

- 盘点数据范围、量级、敏感级别、依赖关系。
- 定义迁移窗口、停机要求、性能指标。
- 准备迁移工具（ETL、脚本、CDC）、验证方式。

## 操作步骤

1. **迁移设计**
   - 明确迁移类型：全量、增量、双写、同步。
   - 设计数据映射、字段转换、默认值、兼容策略。
   - 规划批次、并发度、校验点。
2. **脚本与工具**
   - 编写迁移脚本（SQL、Python、Laravel Artisan 等），保持幂等。
   - 使用 CDC/消息队列同步增量变更。
   - 对敏感数据进行脱敏/加密。
3. **演练**
   - 在影子环境执行全量/增量演练，记录耗时、资源。
   - 验证数据完整性（行数、校验和、业务校验）。
   - 调整批量大小、索引策略、锁机制。
4. **执行**
   - 按 Runbook 执行，记录步骤、时间、结果。
   - 实时监控性能、错误、日志。
   - 如需停机，提前广播，执行成功后恢复服务。
5. **验证与切换**
   - 完成后执行校验：数据一致性、业务回归、监控指标。
   - 切换读写到新库/新结构。
   - 保留回滚通道（快照、备份、双写期间双向校验）。

## 质量校验

- 迁移脚本/工具经过演练，满足性能指标。
- 校验清单覆盖行数、字段校验、业务核对、日志。
- Runbook 包含失败处理、回滚方案、联系人。

## 失败与回滚

- 迁移失败或超时：立即执行回滚（恢复备份/旧库），分析原因。
- 数据不一致：暂停写入，执行差异对账或补偿脚本。
- 性能影响：调整批次或时间窗口，必要时重新演练。

## 交付物

- 迁移方案、映射文档、脚本仓库。
- 演练与正式执行记录、验证报告。
- 回滚策略、备份位置、联系人列表。
