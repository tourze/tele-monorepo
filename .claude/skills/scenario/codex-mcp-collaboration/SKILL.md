---
name: scenario-codex-mcp-collaboration
description: 规范使用 Codex MCP 工具进行协作，涵盖触发条件、提问框架、会话记录与验证流程。
---

# Codex MCP 协作技能

## 适用场景

- 结论把握低于 80%，需要第二视角验证关键决策。
- 涉及跨模块、高风险变更或复杂假设，需要额外论证。
- 工具或权限受限、信息缺口明显，需要借助 Codex MCP 获取线索。

## 前置准备

- 确认当前环境已注册 `mcp__codex__codex` 与 `mcp__codex__codex-reply` 工具，或记录不可用原因。
- 梳理待解决的问题，明确期望 Codex 返回的输出格式与质量门。

## 提问框架模板

构造 Codex MCP 提问时，建议包含以下结构：

### 上下文

- **任务背景**：当前正在执行的任务、目标与范围
- **客观证据**（📌 仅包含可验证的事实）：
  - 命令输出：完整的错误信息、日志
  - 代码片段：实际文件内容，带文件路径和行号
  - 测试结果：失败的断言、堆栈跟踪
  - 配置内容：实际配置文件片段
- **我的推断**（⚠️ 明确标注为待验证假设）：
  - 列出目前的分析结论
  - 标注每个推断的把握度（高/中/低）
  - 说明推断依据（基于哪些证据）
- **不确定点**（🤔 需要你帮助验证）：
  - 列出分析中的疑点
  - 指出可能存在错误理解的地方

### 问题

- **明确的疑问点**：需要 Codex 解答的具体问题
- **备选方案**：已识别的可能解决方案，需要评估优劣

### 期望

- **输出格式**：期望返回判断（是/否）、建议（推荐方案）、还是代码示例
- **决策标准**：基于什么标准进行判断（性能/可读性/兼容性/风险）

## 操作步骤

### 基础流程

1. **协作预检**
   - 使用可用命令（如 `list_mcp_resources`）确认 Codex MCP 工具处于可用状态。
   - 若检测失败，立即记录阻塞并通知干系人，暂停向 Codex 发起请求。

2. **构造提问框架**（⚠️ 关键：防止错误传播）
   - **必须**按照"证据与推断分离"原则组织信息：
     - ✅ 客观证据：仅提供可验证的事实（命令输出、代码片段、错误信息）
     - ⚠️ 我的推断：明确标注为"待验证假设"，并说明把握度
     - 🤔 不确定点：主动列出可能存在的错误理解
   - **禁止**将未验证的推断当作"已知事实"传递

3. **发起会话**
   - 调用 `codex`（`mcp__codex__codex`）并提交构造好的 `prompt`；必要时设置 `approval-policy`、`sandbox` 等参数。
   - 记录返回的 `conversationId`，用于后续续问或审计。

4. **多轮验证**（🔄 防止错误固化）
   - **第一轮（上下文验证）**：

     ```markdown
     请先验证我提供的"客观证据"是否完整，"我的推断"是否合理？
     指出我可能遗漏的证据或错误的理解。
     ```

   - **第二轮（深入问题）**：
     - 基于 Codex 纠正后的理解，继续深入问题
     - 使用 `codex-reply` 携带 `conversationId` 续问

5. **独立验证**（📋 验证 Codex 建议）
   - **禁止**直接采纳建议，必须通过以下方式验证：
     - 运行相关命令确认行为
     - 编写测试用例验证逻辑
     - 查阅文档核实假设
   - 验证失败时，回到第4步重新续问

6. **记录与同步**
   - 在计划、Runbook 或变更记录中标注"`MCP 协作`"，列出：
     - 调用命令与 `conversationId`
     - 原始问题与 Codex 建议
     - **验证结果**：采纳/部分采纳/未采纳，附验证证据
   - 未采纳需说明原因与替代方案

## 错误检测机制

### 自检清单（构造提问框架前）

在向 Codex 提问前，必须完成以下自检：

| 检查项 | 问题 | ✅ 通过标准 | ❌ 风险信号 |
|-------|------|------------|------------|
| 证据完整性 | 我提供的证据是原始输出吗？ | 包含完整命令输出、文件路径、行号 | 只有概括性描述 |
| 推断标注 | 我区分了事实和推测吗？ | 明确标注"我的推断"和把握度 | 将推测当作事实 |
| 不确定点 | 我列出了可能错误的地方吗？ | 主动列出3+个疑点 | 没有不确定点 |
| 过早结论 | 我是否基于不完整信息下结论？ | 承认信息不足 | 声称已经理解全貌 |
| 假设验证 | 我的分析基于哪些未验证的假设？ | 列出所有关键假设 | 假设当作事实 |

### 危险信号识别

如果出现以下情况，**必须**重新组织提问框架：

1. **过度自信**：
   - ❌ "我确定问题是X"
   - ✅ "我推断问题是X（把握度：中），因为...,但需要验证..."

2. **缺乏证据**：
   - ❌ "根据经验，这个方法应该..."
   - ✅ "我查看了代码（附代码片段），该方法实际上..."

3. **忽略复杂性**：
   - ❌ "这是个简单问题，只需要..."
   - ✅ "表面看起来简单，但可能涉及...,需要验证..."

**问题**：将"获取配置"这个推断当作事实；没有提供原始代码；假定内联是最佳方案。

## 失败与降级

- MCP 工具不可用或结果不可靠：记录问题并启动人工评审、线下同步等备用方案，必要时创建例外卡。
- 会话仍无法产出可执行结论：检查提问框架是否缺失信息，补齐后再次协作；若依旧失败，升级到负责人判断。
- 高风险建议未经验证禁止直接落地，需先制定回滚方案并获得批准。
- **检测到错误传播**：立即终止当前会话，重新构造提问框架（使用"错误检测机制"自检），启动新会话。
- 如 codex MCP 在 10 分钟内无响应，则可理解为超时，我们应取出请求，并尝试：
  - 拆分传递给 codex 的任务
  - 分多次对 codex 进行询问
  - 分析并缩小 codex 的工作范围、内容

## 验证清单

### 提问前自检

- [ ] 是否完成"错误检测机制"中的5项自检？
- [ ] 是否明确区分了"客观证据"和"我的推断"？
- [ ] 是否列出了至少3个"不确定点"？
- [ ] 是否避免将未验证的假设当作事实？

### 协作过程验证

- [ ] 是否满足触发条件（把握度<80%、高风险、跨模块）？
- [ ] 第一轮是否请求 Codex 验证上下文理解？
- [ ] 提问框架、会话记录、`conversationId` 是否完整记录？

### 结果验证

- [ ] Codex 建议是否通过独立验证（命令/测试/文档）？
- [ ] 是否在计划或结论中引用 Codex 建议并标注来源？
- [ ] 是否记录了验证结果（采纳/部分采纳/未采纳）？
- [ ] 未采纳时是否说明原因与替代方案？
