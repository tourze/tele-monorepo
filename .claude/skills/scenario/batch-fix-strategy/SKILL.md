---
name: scenario-batch-fix-strategy
description: 批量修复策略指南，涵盖批次划分、并行执行、复杂度决策和质量门协同
---

# 批量修复策略技能

## 适用场景
- 需要修复大量相似错误（PHPStan、ESLint、测试失败等）
- 错误类型多样，需要分类处理和优先级排序
- 需要并发执行多个批次以提升效率
- 涉及复杂技术决策，需要Codex MCP协作

## 前置准备
- 收集错误基线数据：总数、分类、影响范围
- 确认质量门工具可用性和配置正确性
- 评估修复复杂度和风险评估
- 制定批次划分原则和并行策略

## 操作步骤

### 1. 错误基线收集与分析
```bash
# 收集错误基线数据
./vendor/bin/phpstan analyze packages/target-bundle --error-format=json | jq '.files | length'
./vendor/bin/phpunit packages/target-bundle/tests --testdox | grep -E "(FAILURES|ERRORS)"
```

### 2. 批次划分策略

#### 批次一：配置和基础设施问题
**目标**：解决工具配置、依赖问题、基类继承
**标准**：
- 配置文件错误
- 依赖缺失或版本冲突
- 基类和接口继承问题
- 自动加载和命名空间问题

**修复策略**：
- 配置文件标准化
- 依赖声明完整性检查
- 基类方法覆盖规范化

#### 批次二：类型安全和标识符规范
**目标**：修复类型错误、标识符命名规范
**标准**：
- PHPStan错误标识符格式（禁止下划线，使用点分隔驼峰）
- 返回类型声明
- 参数类型提示
- 泛型类型注解

**修复策略**：
- 批量替换标识符命名
- 添加缺失的类型声明
- 修复类型不匹配

#### 批次三：数组和访问安全
**目标**：解决数组访问、空指针、边界检查
**标准**：
- 数组访问安全检查
- 空值处理
- 字符串偏移访问
- 方法调用安全性

**修复策略**：
- 添加null检查和断言
- 使用安全的数组访问方法
- 边界条件处理

#### 批次四：复杂度和结构重构
**目标**：降低复杂度、提取方法、优化结构
**标准**：
- 类复杂度 < 50
- 方法复杂度 < 10
- 代码重复率 < 5%
- 圈复杂度合理分布

**修复策略**：
- 提取私有方法和辅助类
- 使用设计模式优化结构
- 重构长方法和复杂条件

### 3. 并行执行原则

#### 并发条件评估
- **独立错误类型**：不同文件、不相关的错误可以并发修复
- **相同错误模式**：相似错误可以使用批量工具并行处理
- **无依赖关系**：批次间无先后依赖，可以同时进行

#### 并发工具使用
```bash
# 使用子代理并发处理不同批次
批次一：配置修复 (Agent A)
批次二：类型修复 (Agent B)
批次三：数组安全 (Agent C)
批次四：复杂度重构 (Agent D)
```

### 4. 复杂度决策框架

#### 重构策略选择
| 复杂度类型 | 推荐策略 | 风险等级 | 验证方式 |
|-----------|---------|---------|---------|
| 类复杂度 > 50 | 提取协作类 | 中 | 接口测试、行为测试 |
| 方法复杂度 > 20 | 提取私有方法 | 低 | 单元测试验证 |
| 条件分支复杂 | 使用卫语句 | 低 | 边界值测试 |
| 数据处理复杂 | 引入Strategy模式 | 中 | 策略测试、性能测试 |

#### Codex MCP协作决策点
当遇到以下情况时，立即启动Codex MCP协作：
- 重构策略把握度 < 80%
- 涉及架构模式选择
- 多种备选方案需要评估
- 风险评估需要第二视角

### 5. 质量门协同验证

#### 验证顺序
1. **语法检查**：`php -l`，确保基本语法正确
2. **静态分析**：PHPStan，检查类型和规范
3. **测试验证**：PHPUnit，确保行为不变
4. **集成测试**：端到端测试，确保功能完整

#### 冲突处理原则
- **类型 vs 测试冲突**：类型优先（避免运行时崩溃）
- **行为 vs 风格冲突**：行为优先（测试验证运行时行为）
- **复杂度 vs 可读性冲突**：基于风险评估决策

## 质量校验
- 每批次修复后错误数递减 > 60%
- 并发处理时总效率提升 > 30%
- 零功能回归，测试通过率 100%
- 复杂度指标符合既定标准

## 失败与回滚
- **错误数量反弹**：重新评估错误分类，检查是否存在隐藏依赖
- **测试失败增加**：回滚最近批次，分析影响范围
- **并发冲突**：串行化处理，优先解决阻塞问题
- **复杂度反弹**：采用渐进式重构，避免一次性大幅修改

## 经验沉淀

### 成功模式
- **4批次策略**：配置→类型→安全→重构，效率提升约40%
- **并发执行**：独立错误类型并行处理，显著缩短周期
- **Codex协作**：复杂技术决策使用MCP，提升决策质量

### 避免陷阱
- **批次边界不清**：明确批次目标和验收标准
- **过度并发**：确保批次间独立性，避免相互干扰
- **忽视验证**：每批次完成后立即运行质量门验证
- **复杂决策独行**：复杂重构及时寻求协作

## 交付物
- 批次划分计划和执行清单
- 并发执行配置和监控机制
- 质量门验证报告和趋势分析
- Codex MCP协作记录和决策文档
- 技术债务清理计划和时间表