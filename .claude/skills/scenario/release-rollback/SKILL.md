---
name: scenario-release-rollback
description: 当需要规划并执行发布、灰度与回滚流程，覆盖 Preflight 检查、监控、数据库迁移及应急策略时，请加载本技能。
allowed-tools: Read(*), Write(*), Edit(*), MultiEdit(*), Bash(*), Glob(*), Grep(*), TodoWrite
---

# 发布与回滚技能

## 适用场景

- 准备将新功能部署至测试/预发/生产环境。
- 管理滚动、蓝绿、金丝雀发布策略。
- 设计回滚步骤、健康检查与监控告警。

## 前置准备

- 明确发布范围、目标环境、窗口时间、干系人。
- 确认 CI/CD 状态、镜像/包版本、迁移脚本准备。
- 建立观察面板：日志、指标、报警阈值。

## 操作步骤

1. **Preflight 检查**
   - 健康：确认目标环境服务、依赖（DB/Cache/消息）可用。
   - 迁移：核对数据库 expand→switch→contract 阶段，准备回滚脚本。
   - 配置：验证环境变量、密钥、特性开关已配置。
2. **发布策略**
   - **滚动发布**：分批替换实例；确保负载均衡权重动态调整。
   - **蓝绿部署**：准备新旧环境的切换脚本与回退命令。
   - **金丝雀**：选择代表性流量，设定阈值与自动化熔断。
3. **执行过程**
   - 记录开始时间、操作步骤、执行人。
   - 按计划执行部署脚本或管道，实时监控 RED 指标。
4. **验证与观察**
   - 发布后执行冒烟测试或健康检查脚本。
   - 观察关键指标（错误率、延迟、业务 KPI）至少一个监控周期。
5. **回滚决策**
   - 确认触发阈值：错误率>阈值、关键功能失效、性能恶化。
   - 立即执行回滚脚本（`git revert`、镜像回退、关闭特性开关）。
   - 若涉及数据，执行恢复脚本或从备份恢复。
6. **复盘**
   - 记录发布与回滚日志、影响范围、改进建议。
   - 更新 Runbook，调整阈值或流程。

## 质量校验

- 发布前质量门执行完毕（参 `scenario-quality-gates`）。
- 预演回滚，确保脚本可重复执行。
- 监控仪表盘、报警规则已验证有效。

## 失败与回滚

- 发布失败：立即中止，执行回滚计划，通知干系人。
- 回滚失败：启用应急预案（扩容旧版本、降级功能、手动修复）。
- 数据不一致：执行数据修复脚本，必要时从备份恢复并记录差异。

## 交付物

- 发布计划与脚本（含命令、参数、顺序）。
- 回滚方案、触发条件、所需时间。
- 监控/报警配置、发布后验证报告、复盘结论。
