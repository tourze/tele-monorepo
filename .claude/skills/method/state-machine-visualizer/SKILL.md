---
name: method-state-machine-visualizer
description: 读取命令状态机并用 Mermaid 高亮当前/最终状态，支撑工作流复盘。
allowed-tools: Read(*), Write(*), Edit(*), MultiEdit(*), Bash(*), Glob(*), Grep(*), TodoWrite
---

# 状态机可视化技能

## 适用场景

- 展示基于状态机的命令执行路径，支持进行中或已完成的复盘。
- 将命令定义中的状态转移表转化为可读的 Mermaid 图并输出摘要。
- 需要明确当前状态、下一步与交付物，提升协作透明度。

## 前置准备

- 回顾最近的命令执行记录，确认目标命令及其当前/最终状态。
- 读取 `.claude/commands/<command>.md`，提取状态表、转移条件、终止状态。
- 准备 Mermaid `graph TD` 模板以及状态高亮样式：
  - 进行中状态：`fill:#ffcc00`
  - 成功结束：`fill:#00ff00`
  - 失败结束：`fill:#ff4444`

## 操作步骤

1. **定位工作流**
   - 在会话中查找最近的状态机命令输出或状态日志。
   - 若有活动工作流优先使用，否则选择最新完成的工作流。
2. **解析定义**
   - 从命令文档复制状态机表或伪代码，识别状态、转移、循环。
   - 明确降级路径（自愈上限、升级/终止状态）。
3. **构建图形**
   - 使用 `graph TD` 绘制节点与边，节点名称格式 `STATE_NAME["STATE_NAME<br/>说明"]`。
   - 根据当前状态/最终状态应用对应样式 `style STATE_X fill:#...`.
   - 对循环与分支使用命名边，必要时添加 `subgraph` 分组。
4. **生成摘要**
   - 活动工作流：描述当前状态目标、可能转移、下一步操作。
   - 已完成工作流：引用最终报告摘要（结果、变更、质量门、交付物）。
   - 若命令内嵌基线有关键提醒（如质量门顺序），在摘要中回顾。
5. **输出格式**
   - 先输出简短引导语，再嵌入 Mermaid 代码块。
   - 图后附摘要列表或段落，避免额外装饰。

## 质量校验

- Mermaid 渲染成功：所有节点单行声明，避免中文标点与 HTML 标签。
- 高亮状态准确：仅对当前/终止状态应用样式，其他节点保持默认。
- 摘要与状态一致，描述清晰、可复核。
- 引用的执行结果（命令、提交、质量门）与会话记录匹配。

## 失败与回滚

- 未找到状态机记录：明确说明并提示用户提供命令上下文。
- 图表渲染失败：检查语法、换行、缩进，必要时拆分子图。
- 状态识别错误：重新核对命令输出，修正摘要与样式。

## 交付物

- Mermaid 状态机图（代码块）。
- 文字摘要（当前状态/最终结果、下一步或交付物）。
