---
name: method-concurrency-guard
description: 当需要设计并发控制与幂等策略，处理后端事务、锁、队列及前端竞态风险时，请加载本技能。
allowed-tools: Read(*), Write(*), Edit(*), MultiEdit(*), Bash(*), Glob(*), Grep(*), TodoWrite
---

# 并发防护技能

## 适用场景

- 处理高并发写操作、库存/计数类场景。
- 修复重复提交、竞态条件、脏写/幻读问题。
- 构建前端请求幂等、取消、等待策略。

## 前置准备

- 理解业务一致性需求：强一致、最终一致、可接受重复。
- 获取数据模型、事务边界、现有锁策略。
- 准备监控指标（并发量、失败率）、复现脚本。

## 操作步骤

1. **并发分析**
   - 识别共享资源（数据库行、缓存键、外部接口）。
   - 使用时序图画出并发交互顺序，标注 CRITICAL 区域。
2. **后端策略**
   - 数据库层：使用事务隔离级别、乐观锁（版本号）、悲观锁（`SELECT ... FOR UPDATE`）。
   - 应用层：采用分布式锁（Redis、Zookeeper），设置超时与重试。
   - 消息队列：引入顺序消费、去重键（idempotent key）。
3. **幂等设计**
   - API 要求客户端提供幂等键（如订单号），后端存储处理结果。
   - 函数设计成幂等：重复调用不会改变最终状态。
4. **前端竞态**
   - 使用 AbortController 取消过期请求。
   - 对重复按钮点击加防抖或禁用。
   - 使用 `Promise.race` 处理超时与兜底。
5. **验证**
   - 编写并发测试：`ab`, `wrk`, `k6`, PHPUnit 并发测试、Jest 多请求。
   - 运行 Red/Use 指标监控，观察错误率与延迟。
6. **回滚计划**
   - 记录锁策略与可能的死锁风险；准备禁用锁或降级方案。
   - 若使用消息补偿，定义手动重放步骤。

## 质量校验

- 并发测试通过，无数据冲突或异常。
- 监控指标稳定，错误率在阈值内。
- 文档更新：标注锁范围、幂等键、失败重试策略。

## 失败与回滚

- 死锁/性能下降：收集慢查询与锁监控，必要时回滚锁策略。
- 幂等键冲突：清理旧数据或增加唯一约束。
- 消息重复消费：增加去重缓存或 Idempotent 表。

## 交付物

- 并发控制方案文档（流程图 + 表格）。
- 幂等实现与测试结果。
- 回滚/降级策略与监控配置。
