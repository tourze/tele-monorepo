<!--
Sync Impact Report
==================
Version Change: 2.0.0 → 2.1.0 (MINOR - 新增文件管理原则)
Modified Principles:
  - 工程实践规范新增"文件管理"子节
Added Sections:
  - 文件管理原则（在工程实践规范下）
Removed Sections: N/A
Templates Requiring Updates:
  ✅ plan-template.md - Constitution Check 部分已对齐
  ✅ spec-template.md - 需求与用户故事结构已对齐
  ✅ tasks-template.md - 任务分类已对齐monorepo结构
  ✅ CLAUDE.md - 已更新为运行时指导
Follow-up TODOs:
  - TODO(RATIFICATION_DATE): 需用户确认正式采纳日期
  - 已删除旧的 feature-* 相关 TODOs（已完成重构）
-->

# VibeShell Monorepo Constitution

## 核心原则

### I. Monorepo 统一治理

所有项目级子仓库放置于 `apps/` 目录，可复用的包放置于 `packages/` 目录。
使用 Yarn Workspaces 作为统一的依赖管理和构建编排工具。不混用 npm 或 pnpm，
确保依赖提升、版本锁定和构建缓存的一致性。

**原因**: 统一的项目结构和工具链避免了"工具分裂"，降低维护成本，提升开发效率。

### II. 多语言协同开发

同时支持 PHP 和 JavaScript/TypeScript 的开发环境。每个技术栈遵循自身最佳实践，
但共享统一的代码质量标准（静态分析、测试覆盖率、文档要求）。跨语言组件通过
明确的接口契约（JSON-RPC、REST API、事件总线）进行通信。

**原因**: 不同业务场景需要不同技术栈的优势，统一质量标准确保整体系统的可维护性。

### III. 测试驱动开发 (TDD)

所有新功能必须先编写测试，测试失败后才开始实现。遵循红-绿-重构循环。
对于 bug 修复，必须先编写能复现问题的测试用例。测试分为单元测试、集成测试
和端到端测试三个层次，每个层次有明确的职责边界。结论需引用命令或文件片段支撑。

**原因**: 预防回归错误，提高代码可维护性，测试即文档，证据即信任。

### IV. 渐进式交付

功能开发按用户故事优先级（P1、P2、P3）进行。每个用户故事必须能独立开发、
测试和部署。优先交付 P1 故事作为 MVP，后续故事增量添加价值而不破坏已有功能。
支持 FRD（商业驱动）和 Spec（用户故事驱动）双轨并行。

**原因**: 快速验证价值假设，降低交付风险，支持敏捷迭代，兼容不同决策模式。

### V. 显式依赖管理

工作区之间的依赖必须显式声明在 package.json 中。禁止隐式的文件系统引用
或环境变量依赖。共享包必须有清晰的版本策略和向后兼容保证。

**原因**: 避免"幽灵依赖"，确保构建可重现，支持独立部署。

### VI. 可观测性优先

所有服务和关键业务流程必须有结构化日志、指标监控和分布式追踪。
错误必须包含足够的上下文信息用于调试。性能指标需设定基线并持续监控。

**原因**: 生产环境问题的快速定位和解决依赖于完善的可观测性基础设施。

### VII. 双轨工作流

支持两种互补的功能开发模式：FRD（Feature Requirements Document）强调商业价值、
指标链路和灰度策略；Spec（Specification）强调用户故事、测试场景和渐进交付。
两种模式可根据项目特点选择或组合使用，共享质量标准和交付流程。

**原因**: 不同类型的功能需要不同的规划方法，灵活性提高交付成功率。

### VIII. 技能驱动执行

技能库（`.claude/skills/`）是执行标准的单一事实来源。每个技能定义明确的
触发场景、操作步骤、验证方法和回滚策略。技能分为语言、工具、场景、方法四层，
通过组合实现复杂任务。遇到缺失场景，优先补齐技能。

**原因**: 标准化的执行流程确保质量一致性，知识沉淀提升团队效率。

### IX. 证据链管理

任何计划必须同步更新并在同轮启动首个动作。每个结论必须有命令输出或文件引用支撑，
若为推断需标注不确定度。输出结果需附执行命令、关键信息与结论，做到"结论-证据"
一一映射。重大任务结束后输出复盘与记忆卡。

**原因**: 可追溯性是工程质量的基础，透明度建立信任，知识沉淀避免重复错误。

## 工程实践规范

### 设计原则

- 坚持 SOLID、KISS、DRY、YAGNI 原则
- 避免"先写后补证据"的工作模式
- 单次迭代保持最小可行变更
- 复杂度增加必须有充分理由并记录在案

### 文件管理

- **最小文件原则**：永远不创建不必要的文件，优先编辑现有文件
- **明确请求原则**：只有当用户明确要求"生成报告文件"或任务确实需要持久化记录时，才创建新文件
- **仓库清洁原则**：避免创建临时文件、报告文件或其他非核心文件，保持仓库清洁
- **复盘归档原则**：重大任务的复盘优先在对话中呈现或更新到现有文档（如宪法的 Sync Impact Report）

**原因**: 脏文件累积降低仓库可维护性，临时报告通常无长期价值，保持仓库清洁有助于聚焦核心代码。

### 安全底线

- 无硬编码密钥、密码、内网地址
- 禁止直接拼接 SQL/Shell/URL，涉及外部输入必须校验与转义
- 反序列化仅处理可信输入
- 第三方库需通过漏洞扫描（osv.dev + snyk）
- 更改环境配置前需说明风险与回滚方案

### 工作流程

1. **澄清与定位**：确认需求范围、已有上下文、风险假设
2. **计划编排**：列出 Todo 并建立执行节奏，识别首个可执行动作
3. **技能执行**：按技能说明书执行，沉淀证据，必要时串联多个技能
4. **复核与交付**：对照验证门禁和工程原则，自检通过后输出结论

## 技术约束

### 工具链标准化

- **包管理器**: Yarn 1.22+ (禁止 npm/pnpm)
- **Node.js**: 20.x LTS
- **PHP**: 8.2+
- **代码风格**: ESLint + Prettier (JS/TS), PHP-CS-Fixer + PHPStan (PHP)
- **Git工作流**: 基于功能分支，PR需要通过CI检查
- **文档格式**: Markdown (CommonMark规范)

### 项目结构规范

```
vibe-shell/
├── apps/                    # 应用项目
│   ├── [project-name]/     # 独立应用
│   └── ...
├── packages/               # 共享包
│   ├── [package-name]/    # 可复用模块
│   └── ...
├── .specify/              # 项目规范和模板
│   ├── memory/           # 项目记忆（宪法等）
│   ├── templates/        # 各类模板
│   └── scripts/          # 自动化脚本
├── .claude/               # AI协作配置
│   ├── skills/           # 技能库（执行标准）
│   ├── commands/         # 斜杠命令
│   └── hooks/            # 自动化钩子
├── specs/                 # 特性规范文档
│   └── [###-feature]/    # 按特性组织
└── docs/                  # 项目文档
```

## 质量门禁

### 代码提交前

- 静态分析必须通过（0 errors）
- 单元测试覆盖率 ≥ 80%
- 代码格式化检查通过
- commit message 遵循约定式提交规范
- 技能执行需声明并引用文档

### PR 合并前

- 所有 CI 检查通过
- 至少一位其他开发者的 code review
- 相关文档已更新
- 无未解决的安全漏洞（通过依赖扫描）
- 验证是否符合本宪法

### 发布前

- 集成测试和端到端测试通过
- 性能基线测试无退化
- 变更日志已更新
- 回滚计划已准备
- 质量门执行报告完整

### 自检清单

| 检查项 | 说明 | 未达成时的处理 |
| --- | --- | --- |
| ✅ 技能是否正确触发 | 回复中是否声明技能、步骤是否引用技能文档 | 暂停执行，先补充技能声明与引用 |
| ✅ 计划是否同步 | 是否更新 Todo 并推进首个动作 | 立即更新计划并执行首个可验证步骤 |
| ✅ 证据是否完整 | 每个结论是否有命令输出或文件引用支撑 | 回溯缺失证据，补跑命令或注明阻塞原因 |
| ✅ 安全与工程守则 | 是否遵循安全底线、无硬编码、依赖已扫描 | 返工补齐验证或书面说明风险与缓解方案 |
| ✅ 文件管理合规 | 是否避免创建不必要文件，保持仓库清洁 | 删除临时文件，将内容整合到现有文档或对话中 |

## 协作与沟通

### 技能使用规范

- 依托 `SKILL.md` 的 description 自动判定技能触发
- 主动执行时声明：`当前技能：<技能名称>｜备注：<触发缘由>`
- 同一技能内可简化：`继续技能：<技能名称>｜<动作>`
- 切换技能前补充新技能的加载声明

### 透明度原则

- **自驱与连续性**：默认在无阻塞时推进下一步，不等待额外指令
- **决策透明**：所有关键决策与假设必须显式写出
- **先证据后结论**：结论需引用具体证据，推断需标注不确定度
- **知识沉淀**：重大任务结束后输出复盘与记忆卡

### Codex MCP 协作

触发条件：
- 结论可信度 <80%
- 跨团队影响大
- 存在安全/合规疑问
- 技能内显式要求

协作要求：
- 完成"五项自检"：证据完整性、推断标注、不确定点、潜在偏差、假设验证
- 记录 conversationId 与关键结论
- 任何建议都需通过命令或测试独立验证

## 治理规则

### 宪法修订流程

1. 提议必须包含：问题描述、建议方案、影响分析
2. 需要团队 2/3 成员同意
3. 修订需要迁移计划，确保现有项目平滑过渡
4. 版本号遵循语义化版本规范：
   - MAJOR: 不兼容的原则变更
   - MINOR: 新增原则或章节
   - PATCH: 澄清、措辞、修复

### 合规性验证

- 所有 PR 必须验证是否符合本宪法
- 定期（每季度）进行依赖审计和技术债务评估
- 复杂度增加必须有充分理由并记录在案
- 执行 `python3 .claude/skill_audit.py` 验证技能库规范

### 指导文档体系

- **项目宪法**：`.specify/memory/constitution.md`（本文档）
- **运行时指导**：`CLAUDE.md`（AI协作具体指引）
- **技能库说明**：`.claude/skills/README.md`
- **项目规范模板**：`.specify/templates/`
- **命令文档**：`docs/claude/slash-commands.md`
- **钩子配置**：`docs/claude/hooks.md`

**Version**: 2.1.0 | **Ratified**: TODO(RATIFICATION_DATE) | **Last Amended**: 2025-11-12