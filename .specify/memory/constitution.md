<!--
Sync Impact Report
==================
Version Change: 0.0.0 → 1.0.0 (MAJOR - 初始制定)
Modified Principles: 首次制定，包含6个核心原则
Added Sections: 全部章节为新增
Removed Sections: N/A
Templates Requiring Updates:
  ✅ plan-template.md - Constitution Check 部分已对齐
  ✅ spec-template.md - 需求与用户故事结构已对齐
  ✅ tasks-template.md - 任务分类已对齐monorepo结构
Follow-up TODOs:
  - TODO(RATIFICATION_DATE): 需用户确认正式采纳日期
-->

# VibeShell Monorepo Constitution

## 核心原则

### I. Monorepo 统一治理

所有项目级子仓库放置于 `apps/` 目录，可复用的包放置于 `packages/` 目录。
使用 Yarn Workspaces 作为统一的依赖管理和构建编排工具。不混用 npm 或 pnpm，
确保依赖提升、版本锁定和构建缓存的一致性。

**原因**: 统一的项目结构和工具链避免了"工具分裂"，降低维护成本，提升开发效率。

### II. 多语言协同开发

同时支持 PHP 和 JavaScript/TypeScript 的开发环境。每个技术栈遵循自身最佳实践，
但共享统一的代码质量标准（静态分析、测试覆盖率、文档要求）。跨语言组件通过
明确的接口契约（JSON-RPC、REST API、事件总线）进行通信。

**原因**: 不同业务场景需要不同技术栈的优势，统一质量标准确保整体系统的可维护性。

### III. 测试驱动开发 (TDD)

所有新功能必须先编写测试，测试失败后才开始实现。遵循红-绿-重构循环。
对于 bug 修复，必须先编写能复现问题的测试用例。测试分为单元测试、集成测试
和端到端测试三个层次，每个层次有明确的职责边界。

**原因**: 预防回归错误，提高代码可维护性，测试即文档。

### IV. 渐进式交付

功能开发按用户故事优先级（P1、P2、P3）进行。每个用户故事必须能独立开发、
测试和部署。优先交付 P1 故事作为 MVP，后续故事增量添加价值而不破坏已有功能。

**原因**: 快速验证价值假设，降低交付风险，支持敏捷迭代。

### V. 显式依赖管理

工作区之间的依赖必须显式声明在 package.json 中。禁止隐式的文件系统引用
或环境变量依赖。共享包必须有清晰的版本策略和向后兼容保证。

**原因**: 避免"幽灵依赖"，确保构建可重现，支持独立部署。

### VI. 可观测性优先

所有服务和关键业务流程必须有结构化日志、指标监控和分布式追踪。
错误必须包含足够的上下文信息用于调试。性能指标需设定基线并持续监控。

**原因**: 生产环境问题的快速定位和解决依赖于完善的可观测性基础设施。

## 技术约束

### 工具链标准化

- **包管理器**: Yarn 1.22+ (禁止 npm/pnpm)
- **Node.js**: 20.x LTS
- **PHP**: 8.2+
- **代码风格**: ESLint + Prettier (JS/TS), PHP-CS-Fixer + PHPStan (PHP)
- **Git工作流**: 基于功能分支，PR需要通过CI检查

### 项目结构规范

```
vibe-shell/
├── apps/                    # 应用项目
│   ├── [project-name]/     # 独立应用
│   └── ...
├── packages/               # 共享包
│   ├── [package-name]/    # 可复用模块
│   └── ...
├── .specify/              # 项目规范和模板
├── .claude/               # AI协作配置
└── docs/                  # 项目文档
```

## 质量门禁

### 代码提交前

- 静态分析必须通过（0 errors）
- 单元测试覆盖率 ≥ 80%
- 代码格式化检查通过
- commit message 遵循约定式提交规范

### PR 合并前

- 所有 CI 检查通过
- 至少一位其他开发者的 code review
- 相关文档已更新
- 无未解决的安全漏洞（通过依赖扫描）

### 发布前

- 集成测试和端到端测试通过
- 性能基线测试无退化
- 变更日志已更新
- 回滚计划已准备

## 治理规则

### 宪法修订流程

1. 提议必须包含：问题描述、建议方案、影响分析
2. 需要团队 2/3 成员同意
3. 修订需要迁移计划，确保现有项目平滑过渡
4. 版本号遵循语义化版本规范

### 合规性验证

- 所有 PR 必须验证是否符合本宪法
- 定期（每季度）进行依赖审计和技术债务评估
- 复杂度增加必须有充分理由并记录在案

### 指导文档

- 运行时开发指导：`CLAUDE.md`
- 技能库说明：`.claude/skills/README.md`
- 项目规范模板：`.specify/templates/`

**Version**: 1.0.0 | **Ratified**: TODO(RATIFICATION_DATE) | **Last Amended**: 2025-11-12